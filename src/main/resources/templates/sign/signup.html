<!DOCTYPE html>
<html>

<head>
    <title>OUR_TRIP</title>
    <link rel="stylesheet" th:href="@{/cssjs/signup.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <div class="bar">
            <h1 class="logo">
                <a href="/">
                    <img src="/img/logo.png" alt="Travel">
                </a>
            </h1>
            <div class="barleft">
                <div class="allmenu">
                    <a href="">
                        <span class="baricon">
                            <i class="fa-solid fa-bars"></i>
                        </span>
                        <span>Î©îÎâ¥</span>
                    </a>
                </div>
            </div>
            <div class="barright">
                <div class="join">
                    <button th:if="${email == null}">ÌöåÏõêÍ∞ÄÏûÖ</button>
                </div>
                <div class="login" id="login-logout">
                    <button id="login-button" th:if="${email == null}" onclick="loginOrLogin()">Î°úÍ∑∏Ïù∏</button>

                    <button id="login-button" th:if="${email != null}" onclick="loginOrLogout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="subwrapper">
        <nav class="subnav">
            <ul>
                <li>
                    <a href="#">Í≥µÏßÄÏÇ¨Ìï≠</a>
                </li>
                <li>
                    <a href="#">Ïó¨ÌñâÍ≥ÑÌöç</a>
                </li>
                <li>
                    <a href="#">Ïó¨ÌñâÏùºÏßÄ</a>
                </li>
                <li>
                    <a href="#">Í≥†Í∞ùÏÑºÌÑ∞</a>
                </li>
                <!-- Í≤ÄÏÉâÏ∞Ω -->
                <div class="form">
                    <li>
                        <span class="input">
                            <form id="searchForm">
                                <input type="text" id="searchInput" placeholder="Search for places">
                                <input type="button" id="searchButton" class="search_results" value="Í≤ÄÏÉâ">
                            </form>
                        </span>
                    </li>
                </div>
            </ul>
        </nav>
    </div>

    <div class="signupcontainer">
        <div class="signup-head">
            <h2>ÌöåÏõêÍ∞ÄÏûÖ</h2>
            <!-- <img class="logo" src="./images/images2/logo-naver.png"> -->
            <a href="/">
                <button type="button" class="btn-h" id="homeButton">üè†</button>
            </a>
            <div>
            </div>
        </div>
        <form id="signupForm" action="/signup" method="post">
            <!-- Ï¥àÍ∏∞ÏóêÎäî Email ÏûÖÎ†• ÌïÑÎìúÏôÄ "Ïù∏Ï¶ùÏΩîÎìú" ÏûÖÎ†• ÌïÑÎìúÎ•º Ïà®ÍπÄ -->


            <label for="email" id="emailLabel">Email:</label>
            <input type="text" class="email" name="email" id="email" placeholder="Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                onkeyup="validateEmail()">
            <div class="ebox">
                <div id="email-error" class="error-message"></div>
                <div id="email-success" class="success-message"></div>
            </div>

            <button type="button" class="btn-e" id="emailcheckButton" onclick="emailcheck()">Ïù∏Ï¶ùÏΩîÎìú Ï†ÑÏÜ°</button>
            <div id="result2"></div>
            <label for="echeck" id="echeckLabel">Ïù∏Ï¶ùÏΩîÎìú:</label>
            <input type="text" id="echeck" name="echeck" onkeyup="validateEcheck()" style="display: none;">
            <div id="echeck-error" class="error-message"></div>
            <div id="echeck-success" class="success-message"></div>


            <label for="pw" class="pwbox">Password:</label>
            <input type="password" class="pw" name="pw" required title="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" onkeyup="validatePw()"
                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî">
            <div id="pw-error" class="error-message"></div>
            <div id="pw-success" class="success-message"></div>

            <label for="name" class="namebox">Name:</label>
            <input type="text" class="name" name="name" id="name" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî">
            <div></div>
            <label for="phone">Phone Number:</label>
            <input type="text" class="phone" name="phone" id="phone" placeholder="Ìï∏ÎìúÌè∞ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                oninput="this.value = this.value.replace(/[^0-9]/g, ''); validatePhone();" maxlength="11">
            <div id="phone-error" class="error-message"></div>

            <ul> 
               <li><span>
                Birthday: 
                </span></li>
                    
            <li class="birthdetail">
                <label for="birth" class="birthbox">
                <input type="text" class="birth" name="yy" placeholder="yy"
                    oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateBirth();" maxlength="4">
                <!-- <br> -->
                <input type="text" class="birth" name="mm" placeholder="mm"
                    oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateBirth();" maxlength="2"
                    onblur="validateMonth(this);">
                <!-- <br> -->
                <input type="text" class="birth" name="dd" placeholder="dd"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '');validateDay(this, event); updateBirth();"
                    maxlength="2" onblur="validateDay(this);">
            </li>

        </label>
        </ul>
            <li>
                <h1 id="birth" name="birth">ÏÉùÎÖÑÏõîÏùº: </h1>
            </li>

            <button type="button" class="btn" id="signupButton" disabled>Sign Up</button>
            <div id="result"></div>
            <input type="hidden" value=0 id="securitycode">
        </form>
    </div>



    <script>
        const securitycode = document.getElementById("securitycode");
        async function emailcheck() {
            document.getElementById("emailLabel").style.display = "block";
            document.getElementById("email").style.display = "block";
            document.getElementById("email-error").style.display = "block";
            document.getElementById("email-success").style.display = "block";
            document.getElementById("echeckLabel").style.display = "block";
            document.getElementById("echeck").style.display = "block";
            document.getElementById("echeck-error").style.display = "block";
            document.getElementById("echeck-success").style.display = "block";


            const toEmail = document.querySelector('#email');
            const echeck = document.querySelector('#echeck');
            const emailSuccessMessage = document.getElementById('email-success');
            const data = { email: toEmail.value }; // POST ÏöîÏ≤≠ÏúºÎ°ú Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞
            console.log(echeck.value);
            console.log(toEmail.value);
            try {
                const response = await fetch('/emailcheck', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data), // Îç∞Ïù¥ÌÑ∞Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                });

                if (response.ok) {
                    // ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ ÏÑ±Í≥µÏ†ÅÏù∏ Í≤ΩÏö∞Ïùò Ï≤òÎ¶¨
                    const result2 = await response.text(); // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞Ïùò ÏùëÎãµÏùÑ ÌÖçÏä§Ìä∏Î°ú ÏùΩÏùå
                    // console.log('ÏÑúÎ≤Ñ ÏùëÎãµ:', result2);
                    // Ïù¥Ï†ú resultÏóê ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞Ïùò ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏäµÎãàÎã§.

                    console.log(result2);

                    document.getElementById("result2").innerHTML = "Ï†ÑÏÜ°Îê®";
                    securitycode.value = result2;
                    // securitycode+=result;
                    // Update the error/success message
                    const echeckError = document.getElementById("echeck-error");
                    const echeckSuccess = document.getElementById("echeck-success");


                    updateSubmitButton();



                } else {
                    // ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ Ïò§Î•òÏù∏ Í≤ΩÏö∞Ïùò Ï≤òÎ¶¨
                    console.error('ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ Ïò§Î•ò ÏÉÅÌÉúÏûÖÎãàÎã§.');
                }
            } catch (error) {
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÎÇò Îã§Î•∏ ÏòàÏô∏ Ï≤òÎ¶¨
                console.error('Ïò§Î•ò Î∞úÏÉù:', error);
            }
        }


        const emailElement = document.querySelector('#email');
        emailElement.addEventListener('focusout', checkEmailAvailability);

        async function checkEmailAvailability() {
            const email = document.querySelector("[name=email]").value;
            var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

            if (!emailPattern.test(email)) {
                document.getElementById("email-error").textContent = "Ïò¨Î∞îÎ•∏ email ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.";
                document.getElementById("email-success").textContent = '';
                document.getElementById("emailcheckButton").disabled = true;
            } else {
                const response = await fetch(`/checkEmailAvailability?email=${email}`);
                const result = await response.text();
                if (result === "Í∞ÄÏûÖÎ∂àÍ∞Ä") {
                    document.getElementById("email-error").textContent = "Ï§ëÎ≥µÎêú Ïù¥Î©îÏùº Ï£ºÏÜåÏûÖÎãàÎã§.";
                    document.getElementById("email-success").textContent = '';
                    document.getElementById("emailcheckButton").disabled = true;
                } else {
                    document.getElementById("email-error").textContent = "";
                    document.getElementById("email-success").textContent = 'ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.';
                    document.getElementById("emailcheckButton").disabled = false;
                }
                console.log(textContent);
                updateSubmitButton();
            }
        }

        async function validateEcheck() {
            const check = document.querySelector("[name=echeck]").value;
            const echeck = document.querySelector("#echeck");

            if (echeck.style.display !== 'none' && echeck.value === securitycode.value) {
                document.getElementById("echeck-error").textContent = "";
                document.getElementById("echeck-success").textContent = "ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§.";
            } else {
                document.getElementById("echeck-error").textContent = "Ïù∏Ï¶ù Î≤àÌò∏Î•º Îã§Ïãú ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.";
                document.getElementById("echeck-success").textContent = "";
            }

            updateSubmitButton();
        }


        async function validatePw() {
            const pw = document.querySelector("[name=pw]").value;
            var pwPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

            if (!pwPattern.test(pw)) {
                document.getElementById("pw-error").textContent = "ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏòÅÎ¨∏, Ïà´Ïûê, ÌäπÏàòÎ¨∏ÏûêÎ•º Î™®Îëê Ìè¨Ìï®ÌïòÍ≥† 8ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.";
                document.getElementById("pw-success").textContent = "";
            } else {
                document.getElementById("pw-error").textContent = "";
                document.getElementById("pw-success").textContent = 'ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.';
            }

            updateSubmitButton();
        }

        function validatePhone() {
            const phone = document.querySelector("[name=phone]").value;

            if (phone.length !== 11) {
                document.getElementById("phone-error").textContent = "Ìï∏ÎìúÌè∞ Î≤àÌò∏Îäî 11ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.";
            } else {
                document.getElementById("phone-error").textContent = "";
            }

            updateSubmitButton();
        }

        function validateMonth(monthField, event) {
            var value = monthField.value.trim();
            var numericValue = parseInt(value);

            if (value === '' || (numericValue >= 1 && numericValue <= 12)) {
                // ÏûÖÎ†•Í∞íÏù¥ ÎπÑÏñ¥ ÏûàÍ±∞ÎÇò ÏßÄÏ†ïÎêú Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏùÑ ÎïåÎäî ÏïÑÎ¨¥Îü∞ ÏûëÏóÖÏùÑ ÏàòÌñâÌïòÏßÄ ÏïäÏùå
                return;
            }

            // ÏûÖÎ†•Í∞íÏù¥ Îπà Ïπ∏Ïù¥ ÏïÑÎãàÍ≥† 1Î∂ÄÌÑ∞ 12 Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇ† ÎïåÎßå ÏïåÎ¶ºÏ∞ΩÏùÑ ÌëúÏãú
            alert("ÏõîÏùÄ 1Î∂ÄÌÑ∞ 12ÍπåÏßÄÏùò Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§.");
            monthField.value = "";

            if (event) event.stopPropagation();
            updateSubmitButton();
        }

        function validateDay(dayField, event) {
            var value = dayField.value.trim();
            var numericValue = parseInt(value);

            if (value === '' || (numericValue) || numericValue >= 1 && numericValue <= 31) {
                // Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏßÄ ÏïäÍ≥† ÏßÄÏ†ïÎêú Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÏùÑ ÎïåÎäî ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
                return;
            }

            // ÏûÖÎ†•Í∞íÏù¥ ÎπÑÏñ¥ ÏûàÍ±∞ÎÇò Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇ† ÎïåÎßå ÏïåÎ¶ºÏ∞Ω ÎùÑÏö∞Í∏∞
            alert("ÏùºÏùÄ 1Î∂ÄÌÑ∞ 31ÍπåÏßÄÏùò Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§.");
            dayField.value = "";

            if (event) event.stopPropagation();
            updateSubmitButton();
        }

        function updateBirth() {
            const yy = document.querySelector("[name=yy]").value;
            const mm = document.querySelector("[name=mm]").value;
            const dd = document.querySelector("[name=dd]").value;
            const birth = `${yy}-${mm}-${dd}`;

            // "h1" ÌÉúÍ∑∏Ïóê ÎÇ†Ïßú Ï†ïÎ≥¥ Ï∂îÍ∞Ä
            document.getElementById("birth").textContent = `ÏÉùÎÖÑÏõîÏùº: ${birth}`;
            updateSubmitButton();

        }

        //         function emailcheck() {
        //     const emailError = document.getElementById("email-error").textContent;
        //     const emailCheckButton = document.getElementById("emailcheckButton");

        //     if (emailError === 'ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.') {
        //         emailCheckButton.disabled = false;
        //     } else {
        //         emailCheckButton.disabled = true;
        //     }
        // }

        function updateSubmitButton() {
            const echeckError = document.getElementById("echeck-error").textContent;
            const emailError = document.getElementById("email-error").textContent;
            const pwError = document.getElementById("pw-error").textContent;
            const phoneError = document.getElementById("phone-error").textContent;
            const datacheck = document.getElementById("echeck-success").textContent;

            if (emailError === "" && pwError === "" && phoneError === "" && echeckError === "") {
                // Î™®Îì† Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨Î•º ÌÜµÍ≥ºÌïòÍ≥† Ïù¥Î©îÏùº ÌôïÏù∏Ïù¥ "ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§"Ïùº Îïå Í∞ÄÏûÖ Î≤ÑÌäº ÌôúÏÑ±Ìôî
                if (datacheck === "ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§.") {
                    document.getElementById("signupButton").disabled = false;
                } else {
                    document.getElementById("signupButton").disabled = true;
                }
            } else {
                // ÌïòÎÇòÎùºÎèÑ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨Ïóê Ïã§Ìå®ÌïòÍ±∞ÎÇò Ïù¥Î©îÏùº ÌôïÏù∏Ïù¥ "Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"Ïùº Îïå Í∞ÄÏûÖ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                document.getElementById("signupButton").disabled = true;
            }
        }



        document.addEventListener('DOMContentLoaded', function () {
            // Sign Up Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï† Îïå ÎπÑÎèôÍ∏∞ ÌÜµÏã†ÏùÑ ÏãúÏûëÌï©ÎãàÎã§.
            var signupButton = document.getElementById("signupButton");
            signupButton.addEventListener("click", function () {
                var xhr = new XMLHttpRequest();
                var form = document.getElementById("signupForm");
                var formData = {
                    email: form["email"].value,
                    name: form["name"].value,
                    pw: form["pw"].value,

                    phone: form["phone"].value,
                    yy: form["yy"].value,
                    dd: form["dd"].value,
                    mm: form["mm"].value



                }

                console.log(formData);
                xhr.open("POST", "/signup", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var response = xhr.responseText;
                            var result = document.getElementById("result");
                            result.innerHTML = "Í∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.";

                        } else {
                            console.error("Ïò§Î•ò Î∞úÏÉù:", xhr.statusText);
                        }
                    }
                };

                xhr.send(JSON.stringify(formData));
            });
        });
    </script>
</body>

</html>